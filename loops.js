"use strict";function _typeof(e){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,o=Array(t);a<t;a++)o[a]=e[a];return o}function _iterableToArrayLimit(e,t){var a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var o,s,l,r,n=[],i=!0,d=!1;try{if(l=(a=a.call(e)).next,0===t){if(Object(a)!==a)return;i=!1}else for(;!(i=(o=l.call(a)).done)&&(n.push(o.value),n.length!==t);i=!0);}catch(e){d=!0,s=e}finally{try{if(!i&&null!=a["return"]&&(r=a["return"](),Object(r)!==r))return}finally{if(d)throw s}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var defaultPattern="__JJJJJJJJ__|_JJJJJJJJJJ_|JJjjjjjjjJJJ|JJjjjjjjJJJJ|JJjjjjjJJjJJ|JJjjjjjJJjJJ|JJjjjjJJjjJJ|JJjjjjJJjjJJ|JJjjjJJjjjJJ|JJjjjJJjjjJJ|JJjjJJjjjjJJ|JJjjJJjjjjJJ|JJjJJjjjjjJJ|JJjJJjjjjjJJ|JJJJjjjjjjJJ|JJJjjjjjjjJJ|_JJJJJJJJJJ_|__JJJJJJJJ__",urlprefix="loops/",fileFormat=function(){var e=document.createElement("audio");return"function"==typeof e.canPlayType&&""!==e.canPlayType("audio/ogg")}()?"ogg":"mp3",conf={barWidth:850,barHeight:240,fft_size:1024,absoluteTreshold:.5,historySize:20,distributionLaw:"quadratic",colorAlphaTreshold:.5,association:!1,osc:!0,topOffset:70,lightWave:"#eee",darkWave:"#999"},detectPassiveEvents={update:function update(){if("undefined"!=typeof window&&"function"==typeof window.addEventListener){var e=!1,t=Object.defineProperty({},"passive",{get:function get(){e=!0}}),a=function(){};window.addEventListener("testPassiveEventSupport",a,t),window.removeEventListener("testPassiveEventSupport",a,t),detectPassiveEvents.hasSupport=e}}};detectPassiveEvents.update();var $canvas,drawContext,bufferCanvas,bufferContext;function readyset(){if(channel.init(),$canvas=$("#bars"),drawContext=$canvas[0].getContext("2d"),bufferCanvas=$("#bufferCanvas")[0],bufferContext=bufferCanvas.getContext("2d"),ranges.init(),Grid.init("#nullgrid"),$("body *").mousedown(function(){isMouseDown=!0}).on("mouseup dragend",function(){isMouseDown=!1}),$("#fixed-palette .swatch").each(function(){var e=$(this).data("c");$(this).replaceWith(Grid.generateCell(e,"under").addClass("swatch").data("act","swatch").attr("id","swatch-"+e))}),$("body").on("click",".action-button",function(e){actions[$(this).data("act")](e)}).on("click",".tool",function(){$(".tool").removeClass("selected"),$(this).addClass("selected"),brush.mode=$(this).data("tool")}).on("click",".swatch",function(){$(".swatch").removeClass("selected"),$(this).data("c")&&($(this).addClass("selected"),brush.color=$(this).data("c"),$("[data-tool=\"draw\"]").click())}),$("#colorpicker").on("change",function(){brush.color="#"+$(this).val(),brush.mode="draw",$(this).addClass("selected"),$("[data-tool=\"draw\"]").click()}),document.querySelector("body").addEventListener("dragover",handleDragOver,!1),document.querySelector("body").addEventListener("drop",handleFileDrop,!1),document.querySelector("#bufferFileInput").addEventListener("change",handleFileInput,!1),document.querySelector("#overlays").addEventListener("touchmove",function(e){_.each(e.targetTouches,function(e){var t=document.elementFromPoint(e.pageX,e.pageY);t.hasOwnProperty("_tl")&&t._tl.progress(0)})},!1),$.getJSON("upload.php?check").done(function(e){upconf=e}).fail(function(e){console.log(e)}),$(".password-reveal").on("mousedown",function(){$(this).parent().find(".delpass").attr("type","text")}).on("mouseleave mouseup",function(){$(this).parent().find(".delpass").attr("type","password")}),$(".validable").on("input",function(){validations[$(this).data("tovalid")]($(this).val())?$(this).removeClass("invalid"):$(this).addClass("invalid"),validateForm($(this).parents("form"),!0)}),$(".captcha").click(function(e){updateCaptcha($(this).parents(".captchablock"),e.ctrlKey||e.altKey)}),$(".pop-message .i-x-large").click(errBox.closeWithBtn),$("#loop-upload .panel-close").click(loopEditor.hide.bind(loopEditor)),$("#loop-upload form").on("submit",function(e){e.preventDefault(),setLineHeightAsParentHeight($("#loop-upload .hijab")),$("#loop-upload .panel").addClass("p-busy");var t="add";$("#loop-upload form").hasClass("action-edit")&&(t="edit"),$("#loop-upload form").hasClass("action-delete")&&(t="delete");var a=new FormData;if((a.append("action",t),a.append("datatype","loop"),a.append("delpass",$("#loop-upload .delpass").val()),a.append("captcha",$("#loop-upload .captchainput").val()),is_admin&&a.append("is_admin",1),"delete"!=t)&&(a.append("name",$("#loop-upload .filename").val()),["freq","db","smoothing","treshold"].forEach(function(e){return a.append(e,ranges.current[e])}),$("#assoc_pattern").is(":checked")&&a.append("associated_pattern",$("#pattern-toassoc").val()),is_admin)){a.append("is_admin",1);var o=$("#loop-date").val();if(o){var s=$("#loop-time").val()||"00:00:00";o=o+" "+s}o&&a.append("date",o),$("#loop-swf").val()&&a.append("swf",$("#loop-swf").val()),a.append("section",$("#loop-section").val())}if("add"==t){if(!currentCustomTrack.blob)return errBox.pop($("#loop-upload"),"\u0424\u0430\u0439\u043B \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442"),void $("#loop-upload .panel").removeClass("p-busy");if(currentCustomTrack.blob.size/1024>upconf.max_loop_fszkb)return $("#loop-upload .panel").removeClass("p-busy"),void errBox.pop($("#loop-upload"),"\u041F\u0440\u0435\u0432\u044B\u0448\u0435\u043D \u043C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u044B\u0439 \u0440\u0430\u0437\u043C\u0435\u0440 \u0444\u0430\u0439\u043B\u0430 ("+upconf.max_loop_fszkb/1024+" \u041C\u0411).");a.append("loop",currentCustomTrack.blob)}else a.append("original_hash",loopEditor.rawData.original_hash);"edit"==t&&a.append("take_ownership",$("#loop_take_ownership").is(":checked"));var l=new XMLHttpRequest;l.open("POST","upload.php"),l.send(a),l.onload=function(t){if($("#loop-upload .panel").removeClass("p-busy"),200==this.status){try{var e=JSON.parse(this.response);if(!e.error){var a="custom"===e.loop.section?"custom":"default",o=$("#loop-upload .delpass").val();if(localStorage.loop_pass=o,localStorage.pattern_pass||($("#pattern-share .delpass").val(o),localStorage.pattern_pass=o),"loop_add"===e.success&&e.hasOwnProperty("loop")&&(loopLibs[a].add(e.loop),loopEditor.hide()),"loop_edit"===e.success){var s=!1;if(e.loop.hasOwnProperty("section_from")){var l="custom"===e.loop.section_from?"custom":"default";l!==a&&(s=!0)}s?(loopLibs[l].del(e.loop.original_hash,e.loop.section_from),loopLibs[a].add(e.loop)):loopLibs[a].edit(e.loop),_.each(e.changes,function(t,a){e.changes[a]=_.escape(t)}),errBox.pop($("#loop-upload"),e.changes.join(";<br>")+".","success","raw"),loopEditor.unedit()}"loop_delete"===e.success&&(loopLibs[a].del(e.loop.original_hash,e.loop.section),errBox.pop($("#loop-upload"),"\u041B\u0443\u043F \u0443\u0434\u0430\u043B\u0435\u043D.","success"),loopEditor.undel()),$("#loop-library").addClass("open-lib"),$("#ltab-"+a).click(),$("#loop-upload .filename").val("").trigger("input")}else if("prompt_edit"===e.errtype)try{var r=JSON.parse(e.extra_data);loopEditor.prepareEdit(r),errBox.pop($("#loop-upload"),_.escape(e.msg)+" <a href=\"javascript:loopEditor.edit();\">\u041E\u0442\u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043B\u0443\u043F \xAB"+_.escape(r.name)+"\xBB</a>?","prompt","raw")}catch(t){errBox.pop($("#loop-upload"),"\u041D\u0435\u043E\u0436\u0438\u0434\u0430\u043D\u043D\u044B\u0439 \u043E\u0442\u0432\u0435\u0442 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438."),console.log(t)}else errBox.pop($("#loop-upload"),e.msg)}catch(t){if("SyntaxError"==t.name)errBox.pop($("#loop-upload"),"\u041D\u0435\u043E\u0436\u0438\u0434\u0430\u043D\u043D\u044B\u0439 \u043E\u0442\u0432\u0435\u0442 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438."),console.error(this.response);else throw t}updateCaptcha($("#loop-upload .captchablock"))}else errBox.pop($("#loop-upload"),"\u041E\u0448\u0438\u0431\u043A\u0430 XHR. \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438."),console.error(t)}}),$.getJSON("custom_loops.json?"+Math.random()).done(function(e){loopLibs.custom=new TrackList(e,"#custom-loops","custom",!0,$("#ltab-custom i.sorter"),"date","desc",!0,$("#ltab-custom i.play-enabler"))}).fail(console.error),$.getJSON("default_loops.json?"+Math.random()).done(function(e){var t=[{title:"\u041F\u0435\u0440\u0438\u043E\u0434 \u0441\u043C\u0435\u0440\u0442\u0438",sectID:"dead",contents:_.filter(e,{section:"dead"})},{title:"\u041F\u0435\u0440\u0438\u043E\u0434 \u0436\u0438\u0437\u043D\u0438",sectID:"live",contents:_.filter(e,{section:"live"})}];loopLibs["default"]=new TrackList(t,"#default-loops","default",!1,$("#ltab-default i.sorter"),"date","desc",!0,$("#ltab-default i.play-enabler"))}).fail(console.error),$.getJSON("default_patterns.json?"+Math.random()).done(function(e){patternLibs["default"]=new PatternGallery(e,"#default-patterns","default",$("#ptab-default i.sorter"),"date","desc")}).fail(console.error),$.getJSON("custom_patterns.json?"+Math.random()).done(function(e){patternLibs.custom=new PatternGallery(e,"#custom-patterns","custom",$("#ptab-custom i.sorter"),"date","desc")}).fail(console.error),$(".scrollable").mCustomScrollbar({theme:"minimal-dark",scrollInertia:200}),$(".lt-contents").on("mouseenter",".track",function(){var e=$(this).find(".track-name");e[0].scrollWidth<=e[0].offsetWidth||(e.stop().addClass("no-overflow"),e.animate({scrollLeft:e.width()},15*e.width(),"linear"))}).on("mouseleave",".track",function(){var e=$(this).find(".track-name");e[0].scrollWidth<=e[0].offsetWidth||e.stop().animate({scrollLeft:0},"slow","linear",function(){e.removeClass("no-overflow")})}),$(".lib-search").click(function(){$(this).toggleClass("active").parents(".library").toggleClass("search-active").find("input").focus()}),$(".ltab-close, .ptab-close").click(function(){$(this).parents(".library").removeClass("open-lib select-mode")}),$(".tab-switch").click(function(){var e=$(this).data("tabgroup");$(".tab-switch.tabgroup-"+e).removeClass("active"),$(this).hasClass("active")||$(this).addClass("active"),$(".tab-contents.tabgroup-"+e).hide(),$("#"+$(this).data("tab")).show()}),$(".tab-to-select-by-default").click(),$("#loop-library").on("click",".track .i-play",function(){var e=$(this).parents(".track").data("hash"),t=$(this).parents(".tracklist-section").data("id");loopLibs[t].playTrackByHash(e)}).on("click",".track-options .i-download-menu",function(e){e.stopPropagation(),$(".track").removeClass("dl-track ed-track"),$(this).parents(".track").addClass("dl-track")}).on("click",".track-options .i-burger",function(e){e.stopPropagation(),$(".track").removeClass("dl-track ed-track"),$(this).parents(".track").addClass("ed-track")}).on("click",".track-name",function(){$(".track").removeClass("dl-track ed-track")}).on("click",".track",function(e){if($(this).parents(".library").hasClass("select-mode")){e.stopPropagation();var t=$(this).data("hash");$(this).parents(".library").hasClass("select-mode")&&$("#loop-toassoc").val(t)}}),$("#loop-search").on("input",function(){var e=$(this).val().toLowerCase().replace(/\"/,"\\\"");try{injector.remove("loop-search")}catch(t){}e.length?injector.inject("loop-search",".search-active#loop-library .track:not([data-name *= \""+e+"\"]) { display:none; }"):injector.inject("loop-search",".search-active#loop-library .track { display:none; }")}).trigger("input"),$("#pattern-search").on("input",function(){var e=$(this).val().toLowerCase().replace(/\"/,"\\\"");try{injector.remove("pattern-search")}catch(t){}e.length?injector.inject("pattern-search",".search-active#pattern-library .pattern:not([data-name *= \""+e+"\"]) { display:none; }"):injector.inject("pattern-search",".search-active#pattern-library .pattern { display:none; }")}).trigger("input"),$("#unedit-loop").click(loopEditor.unedit.bind(loopEditor)),$(".oncheck-enable").change(function(){$($(this).data("element-toenable")).attr("disabled",!this.checked)}),$("#loop-library").on("click",".dlb-edit",function(){var e=$(this).parents(".track"),t=e.data("hash")+"",a=e.parents(".tabgroup-loops").data("lib"),o=_.find(loopLibs[a].flatList,{original_hash:t});o&&loopEditor.prepareEdit(o,!0)}).on("click",".dlb-delete",function(){var e=$(this).parents(".track"),t=e.data("hash"),a=e.parents(".tabgroup-loops").data("lib"),o=_.find(loopLibs[a].flatList,{original_hash:t});o&&loopEditor.del(o,!0)}),$("#pattern-library").on("click",".pattern-name",function(){var e=$(this).parent().data("lib"),t=$(this).parent().data("id");$(this).parents(".library").hasClass("select-mode")?$("#pattern-toassoc").val(t):patternLibs[e].applyPatternByID(t)}).on("click",".i-edit",function(){var e=$(this).parents(".pattern"),t=e.data("id"),a=e.data("lib"),o=_.find(patternLibs[a].list,{id:t});o&&patternEditor.edit(o)}).on("click",".pattern .i-x-small",function(){var e=$(this).parents(".pattern"),t=e.data("id"),a=e.data("lib"),o=_.find(patternLibs[a].list,{id:t});o&&patternEditor.del(o)}),$("form#pattern-share").on("submit",function(e){e.preventDefault(),setLineHeightAsParentHeight($("#editmode .hijab")),$("#editmode .panel").addClass("p-busy");var t="add";$("#pattern-share").hasClass("action-edit")&&(t="edit"),$("#pattern-share").hasClass("action-delete")&&(t="delete");var a=new FormData;if(a.append("action",t),a.append("datatype","pattern"),a.append("delpass",$("#pattern-share .delpass").val()),a.append("captcha",$("#pattern-share .captchainput").val()),is_admin&&a.append("is_admin",1),"delete"!=t&&(a.append("name",$("#pattern-share .filename").val()),a.append("pattern_string",Grid.getPattern()),a.append("style",$("#cell-style").val()),a.append("osc","off"===$("#osc-sel").val()?"off":$("#osc-color").val()),$("#assoc_loop").is(":checked")&&a.append("associated_loop",$("#loop-toassoc").val()),is_admin)){a.append("is_admin",1);var o=$("#pattern-date").val();if(o){var s=$("#pattern-time").val()||"00:00:00";o=o+" "+s}o&&a.append("date",o),a.append("section",$("#pattern-section").val())}"add"!=t&&a.append("pattern_id",patternEditor.currentID);var l=new XMLHttpRequest;l.open("POST","upload.php"),l.send(a),l.onload=function(t){if($("#editmode .panel").removeClass("p-busy"),200==this.status){try{var e=JSON.parse(this.response);if(e.error)errBox.pop($("#editmode"),e.msg);else{var a=$("#pattern-share .delpass").val();if(localStorage.pattern_pass=a,localStorage.loop_pass||($("#loop-upload .delpass").val(a),localStorage.loop_pass=a),"pattern_add"===e.success&&patternLibs[e.pattern.section].add(e.pattern),"pattern_edit"===e.success){var o=e.pattern.section_from||!1;o?(patternLibs[o].del(e.pattern.id),patternLibs[e.pattern.section].add(e.pattern)):patternLibs[e.pattern.section].edit(e.pattern),_.each(e.changes,function(t,a){e.changes[a]=_.escape(t)}),errBox.pop($("#editmode"),e.changes.join(";<br>"),"success","raw"),patternEditor.unedit()}"pattern_delete"===e.success&&(patternLibs[e.pattern.section].del(e.pattern.id),errBox.pop($("#editmode"),"\u041F\u0430\u0442\u0442\u0435\u0440\u043D \u0443\u0434\u0430\u043B\u0435\u043D.","success"),patternEditor.undel()),$("#pattern-library").addClass("open-lib"),$("#ptab-"+e.pattern.section).click(),$("#loop-upload .filename").val("").trigger("input")}}catch(t){if("SyntaxError"==t.name)errBox.pop($("#editmode"),"\u041D\u0435\u043E\u0436\u0438\u0434\u0430\u043D\u043D\u044B\u0439 \u043E\u0442\u0432\u0435\u0442 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438."),console.error(this.response);else throw t}updateCaptcha($("#pattern-share .captchablock"))}else errBox.pop($("#editmode"),"\u041E\u0448\u0438\u0431\u043A\u0430 XHR. \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438."),console.error(t)}}),localStorage.loops_association)try{conf.association=JSON.parse(localStorage.loops_association),$("#assoc-toggle")[0].checked=conf.association}catch(t){throw t}if($("#assoc-toggle").change(function(){conf.association=localStorage.loops_association=$(this)[0].checked}),localStorage.osc_enabled)try{conf.osc=JSON.parse(localStorage.osc_enabled),conf.osc||($("#osc-toggle")[0].checked=!1,$("body").addClass("osc-disabled"))}catch(t){throw t}$("#osc-toggle").change(function(){conf.osc=localStorage.osc_enabled=$(this)[0].checked,conf.osc?$("body").removeClass("osc-disabled"):$("body").addClass("osc-disabled")}),_.each(styles,function(e,t){var a=Grid.style===t?" selected":"";$("#cell-style").append("<option val=\""+t+"\""+a+">"+t+"</option>")}),$("#cell-style").change(function(){Grid.changeStyle($(this).val())}),$("#osc-color").change(function(){Grid.setOsc($(this).val())}),$("#osc-sel").change(function(){var e=$(this).val();"off"===e?Grid.setOsc("off"):($("body").removeClass("osc-disabled"),conf.osc=!0),"default"===e&&(Grid.recount(),$("#osc-color").attr("disabled",!0)),"custom"===e&&$("#osc-color").attr("disabled",!1)}),$("#loop-upload .delpass").val(localStorage.loop_pass||"").trigger("input"),$("#pattern-share .delpass").val(localStorage.pattern_pass||"").trigger("input")}var injector={inject:function inject(e,t){var a=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css",o.id="injector:"+e,o.styleSheet?o.styleSheet.cssText=t:o.appendChild(document.createTextNode(t)),a.appendChild(o)},remove:function remove(e){var t=document.getElementById("injector:"+e);if(t){var a=document.head||document.getElementsByTagName("head")[0];a&&a.removeChild(document.getElementById("injector:"+e))}}},loopLibs={},patternLibs={},errBox={pop:function pop(e,t,a,o){"undefined"==typeof a&&(a="error"),("undefined"==typeof o||"raw"!==o)&&(o=!1);var s=e.find(".emsgwrap");return o?s.find(".emsgbody").html(t):s.find(".emsgbody").text(t),s.find(".pop-message").removeClass("emsg-error emsg-prompt emsg-success").addClass("emsg-"+a),s.css({visibility:"visible"}),s.animate({opacity:1,top:"-"+(s.height()-20)+"px"},200),s},closeWithBtn:function closeWithBtn(e){e.preventDefault(),errBox.off($(this).parents(".emsgwrap"))},off:function off(e){e.animate({opacity:"0"},200,function(){e.css({visibility:"hidden",top:"0px"})})}};function popError(e,t){$errorbox=e.find(".emsgwrap"),$errorbox.find(".emsgbody").html(t),$errorbox.css({visibility:"visible"}),$errorbox.animate({opacity:1,top:"-"+($errorbox.height()-20)+"px"},400)}function updateCaptcha(e){var t=!!(1<arguments.length&&arguments[1]!==void 0)&&arguments[1];e.find("img.captcha").attr("src","captcha/captcha.php?color=200,200,200&"+Math.random()+(t?"&switch":"")),e.find("input.captchainput").val("").trigger("input")}var loopEditor={visible:!1,state:"add",prepareEdit:function prepareEdit(e,t){this.rawData=e,"undefined"!=typeof t&&t&&this.edit()},add:function add(){this.unedit(),this.undel(),this.show(),errBox.off($("#loop-upload .emsgwrap"))},edit:function edit(){this.undel(),this.state="edit",errBox.off($("#loop-upload .emsgwrap")),$("#loop-upload form").addClass("action-edit"),$("#loopedit-id").text(_.trunc(this.rawData.name,18)),$("#loop-upload .filename").val(this.rawData.name);var e=this.rawData.date.split(" ");$("#loop-date").val(e[0]),$("#loop-time").val(e[1]),$("#loop-section").val(this.rawData.section),$("#loop-swf").val(this.rawData.swf),this.rawData.associated_loop?($("#pattern-toassoc").val(this.rawData.associated_pattern),$("#assoc_pattern")[0].checked=!0):$("#assoc_pattern")[0].checked=!1,$("#assoc_pattern").trigger("change"),this.show()},unedit:function unedit(){"edit"!==this.state||(this.state="add",$("#loop-upload form").removeClass("action-edit"))},del:function del(e){this.rawData=e,this.unedit(),this.state="delete",$("#loopdelete-id").text(_.trunc(e.name,40)),$("#loop-upload form").addClass("action-delete"),this.show()},undel:function undel(){"delete"!==this.state||(this.state="add",$("#loop-upload form").removeClass("action-delete"))},show:function show(){$("#loop-upload .validable").trigger("input");this.visible||($("#loop-upload .captcha").attr("src","captcha/captcha.php?color=200,200,200&"+Math.random()),$("#loop-upload").slideDown("fast"),this.visible=!0)},hide:function hide(){this.visible&&(errBox.off($("#loop-upload .emsgwrap")),$("#loop-upload").slideUp("fast",function(){this.unedit(),this.undel(),this.visible=!1}.bind(this)))}},patternEditor={visible:!1,state:"add",currentID:0,edit:function edit(e){this.undel(),$("#pattern-share").addClass("action-edit"),$("#patternedit-id").text(_.trunc(e.name,40)),$("#pattern-share .filename").val(e.name),e.associated_loop?($("#loop-toassoc").val(e.associated_loop),$("#assoc_loop")[0].checked=!0):$("#assoc_loop")[0].checked=!1,$("#assoc_loop").trigger("change"),e.style&&$("#cell-style").val(e.style).trigger("change"),e.osc&&Grid.setOsc(e.osc),this.state="edit",this.show(e.string),this.currentID=+e.id},unedit:function unedit(){"edit"!==this.state||(this.state="add",$("#pattern-share").removeClass("action-edit"))},del:function del(e){this.currentID=+e.id,this.unedit(),this.state="delete",$("#patterndelete-id").text(_.trunc(e.name,40)),$("#pattern-share").addClass("action-delete"),this.show(e.string)},undel:function undel(){"delete"!==this.state||(this.state="add",$("#pattern-share").removeClass("action-delete"))},show:function show(e){"undefined"==typeof e&&(e=!1),Grid.enterPaintMode(),e&&(Grid.build(e),$("#pattern-library").removeClass("open-lib"));this.visible||($("#pattern-share .captcha").attr("src","captcha/captcha.php?color=200,200,200&"+Math.random()),$(".onshare-show").slideDown("fast"),this.visible=!0,$("#pattern-share .validable").trigger("input"),"default"===$("#osc-sel").val()&&Grid.recount())},hide:function hide(){this.visible&&$(".onshare-show").slideUp("fast",function(){this.unedit(),this.undel(),this.visible=!1}.bind(this))},toggle:function toggle(){this.visible?this.hide():this.show()}},upconf={auth:!1},validations={delpass:function delpass(e){return!!e&&e.length<=upconf.max_delpass_length},captcha:function captcha(e){return!!e},filename:function filename(e){return!!e&&e.length<=upconf.max_filename_length}};function validateForm(e){e.find("button[type=submit]").attr("disabled",!!e.find(".invalid:visible").length)}var actions={export:function _export(){$("#pattern-area").val(Grid.getPattern())},import:function _import(){Grid.build($("#pattern-area").val(),"under")},random:function random(){Grid.randomfill()},revert:function revert(){$("#osc-sel").val("default"),Grid.changeStyle(defaultStyle,defaultPattern)},clear:function clear(){Grid.clear()},close:function close(){Grid.exitPaintMode()},upload:function upload(){document.getElementById("bufferFileInput").click()},download:function download(){Grid.downloadPattern()},upload_loop:function upload_loop(){console.log("loop upload")},share_pattern:function share_pattern(){patternEditor.toggle()},select_loop:function select_loop(e){e.preventDefault(),$("#loop-library").addClass("select-mode open-lib")},select_pattern:function select_pattern(e){e.preventDefault(),$("#pattern-library").addClass("select-mode open-lib")},recount_base_color:function recount_base_color(){Grid.recount()}},isMouseDown=!1;function setLineHeightAsParentHeight(e){e.each(function(){$(this).css({lineHeight:$(this).height()+"px"})})}var Colors={g:"#35752e",G:"#59c44d",y:"#7b7d25",Y:"#cccf41",o:"#805c22",O:"#d2993e",b:"#2e6d90",B:"#4eb6f1",c:"#7b273d",C:"#cc4368",v:"#4e1e84",V:"#8238d8",m:"#686868",M:"#d2d2d2",j:"#468172",J:"#37C999",".":"_VOID_",_:"_VOID_"},colorMatch=new RegExp("(["+_.escapeRegExp(_.keys(Colors).join(""))+"])|\\[(.+?)\\]","g"),colorMatchSqBr=new RegExp("(["+_.escapeRegExp(_.keys(Colors).join(""))+"])|(\\[.+?\\])","g"),styles={legacy:function legacy(e){var t=e.toHexString(),a=e.darken(25).toHexString();return{u:"background: radial-gradient(ellipse at center, "+t+" 34%, "+a+" 81%);",o:"background: "+t}},modern:function modern(e){var t=e.toHexString(),a=e.darken(10).toHexString(),o=e.darken(30).toRgbString();return{u:"background: radial-gradient(ellipse at center 7px, "+t+" 0%, "+a+" 70%);",o:"background: "+t+"; box-shadow: "+t+" 0px 0px 0px 0px, "+t+" 0px 0px 0px 0px, "+o+" 0px 0px 0px 0px"}},flashes:function flashes(e){var t=e.toHexString(),a=e.darken(10).toHexString(),o=e.darken(30).toRgbString();return{u:"background: transparent; box-shadow: none;",o:"background: "+t+"; box-shadow: "+t+" 0px 0px 0px 0px, "+t+" 0px 0px 0px 0px, "+o+" 0px 0px 0px 0px"}},flat:function flat(e){var t=e.toHexString(),a=e.brighten(25).saturate(15).toHexString();return{u:"background: "+t+";",o:"background: "+a+";"}}},defaultStyle="modern";styles.transitional=styles.modern;var globalCSS={legacy:"html {\theight: 100%; \tbackground: #000; \tbackground: -webkit-linear-gradient(top,#404040,#000 195px,#000 380px,#2B2B2B 418px) no-repeat,#2B2B2B; \tbackground: -ms-linear-gradient(top,#404040,#000 195px,#000 380px,#2B2B2B 418px) no-repeat,#2B2B2B; \tbackground: -o-linear-gradient(top,#404040,#000 195px,#000 380px,#2B2B2B 418px) no-repeat,#2B2B2B; \tbackground: -moz-linear-gradient(top,#404040,#000 195px,#000 380px,#2B2B2B 418px) no-repeat,#2B2B2B; \tbackground: linear-gradient(top,#404040,#000 195px,#000 380px,#2B2B2B 418px) no-repeat,#2B2B2B;   }  body {\tfont-family: 'Trebuchet MS',\tTrebuchet, Arial,Helvetica, sans-serif;  }  #shadow {\tbackground: rgba(33, 33, 33, 0.44);\tbox-shadow: 0 0 53px #212121;  }",transitional:"html {\tbackground: #212121;  }  #shadow {\tbackground: rgba(33, 33, 33, 0.44);\tbox-shadow: 0 0 53px #212121;  }",flat:"#nullgrid .cell:not(.void) {border-radius: 0; box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.2);}  #nullgrid .cell.under:not(.void) { box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.2); }"};function xBrowserIsMouseDown(){return isMouseDown}var isChrome=navigator.userAgent.match(/chrome\/([0-9]+)/i);if(isChrome){var chromeVersion=isChrome[1];46<=+chromeVersion&&(xBrowserIsMouseDown=function(){return $("body:active").length})}var animations={legacy:function legacy(){var e=this.style.backgroundColor,t=tinycolor(e).darken(30).toRgbString();this._tl.to(this,.1,{opacity:1,boxShadow:e+" 0px 0px 2px 2px, "+e+" 0px 0px 10px 10px, "+t+" 0px 0px 9px 9px"}).to(this,.4,{opacity:0,boxShadow:e+" 0px 0px 0px 0px, "+e+" 0px 0px 0px 0px, "+t+" 0px 0px 0px 0px"})},flat:function flat(){var e=this.style.backgroundColor;this._tl.to(this,.1,{opacity:1,boxShadow:"inset 0 0 0 1px rgba(0, 0, 0, 0),"+e+" 0px 0px 4px 2px"}).to(this,.6,{opacity:0,boxShadow:"inset 0 0 0 1px rgba(0, 0, 0, 0.2),"+e+" 0px 0px 0px 0px"})}};animations.modern=animations.transitional=animations.flashes=animations.legacy;var _debug_,Grid={init:function init(e){this.$el=$(e);var t=this;this.$el.find(".triangle-group").css({display:"inline-block"}).hide(),this.$el.find(".tg-top .t-up").click(function(){t.resample("top",1,"under")}),this.$el.find(".tg-top .t-down").click(function(){t.resample("top",-1,"under")}),this.$el.find(".tg-bottom .t-up").click(function(){t.resample("bottom",-1,"under")}),this.$el.find(".tg-bottom .t-down").click(function(){t.resample("bottom",1,"under")}),this.$el.find(".tg-left .t-left").click(function(){t.resample("left",1,"under")}),this.$el.find(".tg-left .t-right").click(function(){t.resample("left",-1,"under")}),this.$el.find(".tg-right .t-left").click(function(){t.resample("right",-1,"under")}),this.$el.find(".tg-right .t-right").click(function(){t.resample("right",1,"under")}),this.shuffler=new Rarity(50),"default"!==this.lastOsc&&this.setOsc(this.lastOsc),this.changeStyle(this.baseStyle,this.pattern)},pattern:localStorage.customPattern||"__JJJJJJJJ__|_JJJJJJJJJJ_|JJjjjjjjjJJJ|JJjjjjjjJJJJ|JJjjjjjJJjJJ|JJjjjjjJJjJJ|JJjjjjJJjjJJ|JJjjjjJJjjJJ|JJjjjJJjjjJJ|JJjjjJJjjjJJ|JJjjJJjjjjJJ|JJjjJJjjjjJJ|JJjJJjjjjjJJ|JJjJJjjjjjJJ|JJJJjjjjjjJJ|JJJjjjjjjjJJ|_JJJJJJJJJJ_|__JJJJJJJJ__",baseStyle:localStorage.lastStyle||defaultStyle,lastOsc:localStorage.lastOsc||"default",revert:function revert(){$("#osc-sel").val("default"),this.changeStyle(this.baseStyle,this.pattern)},style:(void 0).baseStyle,changeStyle:function changeStyle(e,t){return _.has(styles,e)?void($("#cell-style").val(e),"undefined"==typeof t&&(t=!1),this.style=e,injector.remove("cellstyle"),_.has(globalCSS,e)&&injector.inject("cellstyle",globalCSS[e]),this.build(t)):console.error("\u041D\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u0442\u0430\u043A\u043E\u0433\u043E \u0441\u0442\u0438\u043B\u044F")},setOsc:function setOsc(e){if("off"===e)return $("#osc-sel").val("off"),$("body").addClass("osc-disabled"),void(conf.osc=!1);conf.osc=!0,"default"===e?($("#osc-color").attr("disabled",!0),e=Grid.primaryColor,$("#osc-sel").val("default")):($("#osc-sel").val("custom"),$("#osc-color").attr("disabled",!1)),$("#osc-toggle")[0].checked&&$("body").removeClass("osc-disabled");var t=$("#osc-color");t[0].hasOwnProperty("color")?t[0].color.fromString(e):t.val(e),-1==e.indexOf("#")&&(e="#"+e),drawContext.fillStyle=e},generateCell:function generateCell(e,t,a){"undefined"==typeof a&&(a=this.style);var o=e.split(/[\[\]]/)[1]||e.split(/[\[\]]/)[0],e=_.has(Colors,o)?tinycolor(Colors[o]):tinycolor(o),s=_.has(Colors,o)?o:"#"+e.toHex().toLowerCase(),a=styles[a](e);if(e._format&&e._a>=conf.colorAlphaTreshold){if("under"==t)return $("<div data-c=\""+s+"\" class=\"cell under\" style=\""+a.u+"\"></div>");var l=$("<div data-c=\""+s+"\" class=\"cell over\" style=\""+a.o+"\"></div>");l[0]._tl=new TimelineLite;var r=function(){this._tl.progress(0)},n=!!detectPassiveEvents.hasSupport&&{passive:!0};return l[0].addEventListener("mouseenter",r,n),l[0].addEventListener("touchstart",r,n),l}return"under"==t?$("<div class=\"cell under void\" data-c=\"_\"></div>"):"over"==t?$("<div class=\"cell void\" data-c=\"_\"></div>"):void 0},lastBuild:{pattern:"",layer:"",style:""},build:function build(e,t){if("string"!=typeof e&&(e=this.getPattern()),"undefined"==typeof t&&(t=$("#grid-wrap").hasClass("edit-mode")?"under":"both"),e=e.replace(/\s+/g,"").replace(/\|{2,}/g,"|").replace(/^\|/g,"").replace(/\|$/g,""),e!==this.lastBuild.pattern||t!==this.lastBuild.layer||this.style!==this.lastBuild.style){this.lastBuild.pattern=e,this.lastBuild.layer=t,this.lastBuild.style=this.style;var a=this.$el.find("#cells"),o=this.$el.find("#overlays");"over"!=t&&a.find(".cell, br").remove(),"under"!=t&&o.find(".cell, br").remove();var s=e.split(/[|\/]/);if(_.each(s,function(e,s){var l=_.compact(e.split(colorMatch));_.each(l,function(e,l){"over"!=t&&this.generateCell(e,"under").attr("id","cu_"+s+"_"+l).appendTo(a),"under"!=t&&this.generateCell(e,"over").attr("id","co_"+s+"_"+l).appendTo(o)},this),"over"!=t&&$("<br>").appendTo(a),"under"!=t&&$("<br>").appendTo(o)},this),"under"!==t)var l=this.style;$(".over").each(animations[l]),this.recount(t)}},enterPaintMode:function enterPaintMode(){$("#overlays").empty(),$("#controls").fadeOut(),$("#editmode").slideDown(),audio.stop(function(){$("#playSwitcher i").removeClass("i-pause-big").addClass("i-play-big")}),$("#cells").on("mousedown mouseenter",".cell",function(e){if(brush.mode&&("mouseenter"!=e.type||xBrowserIsMouseDown()))if("dropper"===brush.mode){var t=$(this).data("c");$(".swatch").removeClass("selected"),_.has(Colors,t)?($("#swatch-"+t).addClass("selected"),brush.color=t):(brush.color=t,$("#colorpicker")[0].color.fromString(tinycolor(t).toHexString()),$("#colorpicker").addClass("selected"),!$("#dynamic-palette [data-c="+t.toLowerCase()+"]").length&&$("#dynamic-palette").prepend(Grid.generateCell(t,"under").addClass("swatch").data("act","swatch").attr("id","swatch-"+t)))}else{var a=$(this).attr("id"),t="eraser"===brush.mode?"_":brush.color;$(this).replaceWith(Grid.generateCell(t,"under").attr("id",a)),_.has(Colors,t)||$("#dynamic-palette [data-c="+t.toLowerCase()+"]").length||$("#dynamic-palette").prepend(Grid.generateCell(t,"under").addClass("swatch").data("act","swatch").attr("id","swatch-"+t)),Grid.lastBuild.pattern=""}}),this.$el.parent().addClass("edit-mode"),$(".triangle-group").slideDown()},brush:!1,saveState:function saveState(e){"undefined"==typeof e&&(e=this.getPattern()),this.pattern=localStorage.customPattern=e,this.baseStyle=localStorage.lastStyle=this.style;var t=$("#osc-sel").val();localStorage.lastOsc="custom"===t?$("#osc-color").val():t},exitPaintMode:function exitPaintMode(){$("#cells").off();var e=this.getPattern();this.lastBuild.pattern="",this.build(e,"over"),this.$el.parent().removeClass("edit-mode"),$(".triangle-group").slideUp(),this.saveState(e),$("#controls").slideDown(),$("#editmode").slideUp()},getPattern:function getPattern(){var e,t=0,a="";return this.$el.find(".cell.under").each(function(){$(this).attr("id").split("_")[1]>t&&(a+="|",t++),e=$(this).data("c"),1<e.length&&(e="["+e+"]"),a+=e}),a},recount:function recount(e){"undefined"==typeof e&&(e=$("#grid-wrap").hasClass("edit-mode")?"under":"over");var t="under"===e?"under":"over",a=document.querySelectorAll(".cell."+t+":not(.void)");"under"!==e&&(this.cells=a,this.intoRows(),this.cellCount=this.cells.length,this.trimmingConstant=Math.floor(Math.sqrt(this.cellCount)));var o=function(e){return _.invert(e)[_.max(e)]}(_.countBy(_.pluck(_.pluck(a,"dataset"),"c")));this.primaryColor=_.has(Colors,o)?Colors[o]:tinycolor(o).toHexString(),"default"==$("#osc-sel").val()&&this.setOsc("default");var s=this.$el.find("#cells").height(),l=this.$el.find("#cells").width();$(".wrapper-xh").css({top:s+conf.topOffset-conf.barHeight+"px"}),$("#shadow").width(l+20),this.height=s/20,this.width=l/20;var r=this.width,n=this.height;$("#sizeIndicator").text(r+" \xD7 "+n)},flash:function flash(e){e+1<=this.cellCount&&this.cells[e]._tl.progress(0)},intoRows:function intoRows(){var e=[];Array.prototype.forEach.call(this.cells,function(t){var a=t.getAttribute("id").split("_"),o=_slicedToArray(a,3),s=o[0],l=o[1],r=o[2];e[l]||(e[l]=[]),e[l][r]=t}),this.cellsArranged=e.reverse()},flashXY:function flashXY(e,t){var a=this.cellsArranged[t];if(a){var o=a[e];o&&o.hasOwnProperty("_tl")&&o._tl.progress(0)}},flashRow:function flashRow(e){var t=Math.floor,a=this.cellsArranged[e];if(a)for(var o,s=0;s<this.flashDensity;)o=a[t(Math.random()*a.length)],o&&o.hasOwnProperty("_tl")&&o._tl.progress(0),s++},flashDensity:1,resample:function resample(e,t,a){var o=this.getPattern(),s=o.split(/[|\/]/),l=[];if(!(isNaN(t)||0===t)){if(0>t){var r=_.includes(["left","top"],e)?_.drop:_.dropRight;l=_.includes(["left","right"],e)?_.map(s,function(e){var a=_.compact(e.split(colorMatchSqBr));return r(a,-t).join("")}):r(s,-t)}if(0<t&&("left"==e&&(l=_.map(s,function(e){return _.repeat("_",t)+e})),"right"==e&&(l=_.map(s,function(e){return e+_.repeat("_",t)})),_.includes(["top","bottom"],e))){var n=_.compact(_.max(s,function(e){return _.compact(e.split(colorMatch)).length}).split(colorMatch)).length,i=_.times(t,function(){return _.repeat("_",n)});l="top"==e?i.concat(s):s.concat(i)}this.build(l.join("|"),a)}},randomfill:function randomfill(){this.$el.find(".cell.under").each(function(){var e=.5<=Math.random()?tinycolor.random().toHexString():"_",t=$(this).attr("id");$(this).replaceWith(Grid.generateCell(e,"under").attr("id",t))})},clear:function clear(){this.$el.find(".cell.under").each(function(){var e=$(this).attr("id");$(this).replaceWith(Grid.generateCell("_","under").attr("id",e))})},fromCanvas:function fromCanvas(){var e,t,a,o=bufferCanvas.height,s=bufferCanvas.width,l="";for(t=0;t<o;t++){for(e=0;e<s;e++)a=bufferContext.getImageData(e,t,1,1).data,l+="[rgba("+a[0]+","+a[1]+","+a[2]+","+a[3]+")]";t!=o-1&&(l+="|")}this.build(l)},downloadPattern:function downloadPattern(){$("#bufferLink").attr("href",this.toCanvas())[0].click()},toCanvas:function(e,t,a){var o=Math.ceil,s=Math.floor;"undefined"==typeof t&&(t=this.width),"undefined"==typeof a&&(a=this.height),bufferCanvas.width=t,bufferCanvas.height=a,"undefined"==typeof e&&(e=this.getPattern());var l,r=new Uint8ClampedArray(4*(t*a)),n=0,d=e.split(/[|\/]/);_.each(d,function(e){var a=_.compact(e.split(colorMatch));if(a.length<t){var i=t-a.length,d=s(i/2),p=o(i/2);_.times(d,function(){a.unshift("_")}),_.times(p,function(){a.push("_")})}_.each(a,function(e){var t=_.has(Colors,e)?tinycolor("_VOID_"==Colors[e]?"rgba(0,0,0,0)":Colors[e]):tinycolor(e.replace(/[\[\]]/g,""));l=4*n,r[l]=t._r,r[l+1]=t._g,r[l+2]=t._b,r[l+3]=255*t._a,n++})}),_debug_={output:r,width:t,height:a},bufferContext.clearRect(0,0,bufferCanvas.width,bufferCanvas.height);var p=bufferContext.createImageData(t,a);return p.data.set(r),bufferContext.putImageData(p,0,0),bufferCanvas.toDataURL("image/png")}},brush={mode:!1,color:"J"};function _test(e){for(var t=0;t<e;t++)setInterval(function(){Grid.flash(_.random(0,Grid.cellCount-1))},_.random(400,3e3))}var expectedLoop,ranges={defaults:{freq:[0,18e3],db:[-120,0],smoothing:.1,treshold:1.5},current:{},init:function init(){var e=this;this.freq=$("#frequency_range").ionRangeSlider({type:"double",min:0,max:this.sampleRate/2,min_interval:1e3,drag_interval:!0,grid_num:6,values_separator:"...",grid:!0,from:this.defaults.freq[0],to:this.defaults.freq[1],onChange:function onChange(t){e.current.freq=[t.from,t.to],e.current.numSamples=e.hz2samples(t.to-t.from),e.current.sampleOffset=e.hz2samples(t.from)}}).data("ionRangeSlider"),this.db=$("#dynamic_range").ionRangeSlider({type:"double",min:-200,max:0,from:this.defaults.db[0],to:this.defaults.db[1],min_interval:10,grid_num:5,values_separator:"...",drag_interval:!0,grid:!0,onChange:function onChange(t){e.current.db=[t.from,t.to],visualizer.analyser.minDecibels=t.from,visualizer.analyser.maxDecibels=t.to}}).data("ionRangeSlider"),this.smoothing=$("#smoothing").ionRangeSlider({min:0,max:1,step:.01,from:this.defaults.smoothing,grid:!0,onChange:function onChange(t){e.current.smoothing=t.from}}).data("ionRangeSlider"),this.treshold=$("#treshold").ionRangeSlider({min:.5,max:3,step:.01,grid_num:5,from:this.defaults.treshold,grid:!0,onChange:function onChange(t){e.current.treshold=t.from}}).data("ionRangeSlider"),this.sync()},get sampleRate(){try{return audio.context.sampleRate}catch(t){return 48e3}},get fftSize(){try{return visualizer.analyser.fftSize}catch(t){return conf.fftSize}},hz2samples:function hz2samples(e){return Math.round(e/(this.sampleRate/this.fftSize))},samples2hz:function samples2hz(e){return Math.round(e*(this.sampleRate/this.fftSize))},sync:function sync(){var e=this,t=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{};t=_.defaults(t,this.defaults),this.freq.update({max:this.sampleRate/2,from:t.freq[0],to:t.freq[1]}),this.db.update({from:t.db[0],to:t.db[1]}),this.smoothing.update({from:t.smoothing}),this.treshold.update({from:t.treshold}),["freq","db","smoothing","treshold"].forEach(function(t){return e[t].callOnChange()})}},audio={buffer:{},compatibility:{},supported:!0,source_loop:{},source_once:{},disabled:!0},currentLoop={};audio.stop=function(e){audio.source_loop._playing?(TweenLite.to(gainNode.gain,.2,{value:0,onComplete:function onComplete(){audio.source_loop[audio.compatibility.stop](0),audio.source_loop._playing=!1,audio.source_loop._startTime=0,"noteOn"===audio.compatibility.start&&audio.source_once[audio.compatibility.stop](0),"function"==typeof e&&e()}}),$(".wrapper-decor").fadeOut()):"function"==typeof e&&e()},audio.loadLoop=function(e,t){audio.disabled=!0;var a={};if("object"===_typeof(t))a=t;else return console.log("unsupported");var o=new XMLHttpRequest,s=""+t.original_hash+new Date().getTime();expectedLoop=s,o.onload=function(){s===expectedLoop&&audio.context.decodeAudioData(o.response,function(t){ranges.sync(a),audio.buffer=t,audio.source_loop={},currentLoop=a,audio.disabled=!1,e&&audio.play()})},audio.stop(function(){o.open("GET",urlprefix+t.section+"/"+t.original_hash+"."+fileFormat,!0),o.responseType="arraybuffer",o.send()})};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,audio.context=new window.AudioContext}catch(t){audio.supported=!1}var gainNode,visualizer={};audio.supported&&(function(){var e="start",t="stop",a=audio.context.createBufferSource();"function"!=typeof a.start&&(e="noteOn"),audio.compatibility.start=e,"function"!=typeof a.stop&&(t="noteOff"),audio.compatibility.stop=t}(),gainNode=audio.context.createGain(),gainNode.gain.value=1,visualizer=new VisualizerSample,gainNode.connect(visualizer.analyser)),audio.play=function(){return(TweenLite.to(gainNode.gain,0,{value:1}),audio.disabled)?AllTracks.random():(audio.source_loop._playing?(audio.stop(),$("#playSwitcher i").removeClass("i-pause-big").addClass("i-play-big")):($(".wrapper-decor").fadeIn(),audio.source_loop=audio.context.createBufferSource(),audio.source_loop.buffer=audio.buffer,audio.source_loop.loop=!0,audio.source_loop.connect(gainNode),"noteOn"===audio.compatibility.start?(audio.source_once=audio.context.createBufferSource(),audio.source_once.buffer=audio.buffer,audio.source_once.connect(gainNode),audio.source_once.noteGrainOn(0,0,audio.buffer.duration),audio.source_loop[audio.compatibility.start](audio.buffer.duration)):audio.source_loop[audio.compatibility.start](0,0),audio.source_loop._playing=!0,!visualizer._drawing&&(frame(visualizer.draw.bind(visualizer)),visualizer._drawing=!0),$("#playSwitcher i").removeClass("i-play-big").addClass("i-pause-big")),!1)};var frame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();function record_mode(){conf.topOffset=110,Grid.recount(),injector.inject("recmode","#grid-wrap {  margin-top: 66px } .player-controls {opacity: 0} .player-controls:hover {opacity: 1}")}function logIfDown(){xBrowserIsMouseDown()&&console.dir.apply(this,arguments)}function VisualizerSample(){this.analyser=audio.context.createAnalyser(),this.analyser.connect(audio.context.destination);try{this.analyser.fftSize=conf.fft_size,$("label[for=fft_size] .indicator").removeClass("illegal")}catch(t){$("label[for=fft_size] .indicator").addClass("illegal")}this.samples=new Uint8Array(this.analyser.frequencyBinCount)}var channel={init:function init(){this.canvas=$("#samplecanvas")[0],this.ctx=this.canvas.getContext("2d"),this.canvas.width=conf.fft_size/2},debugOn:!1,history:[],current:[],tick:function tick(e){for(var t=Math.abs,a=Math.pow,o=Math.round,s=Math.floor,l=ranges.current.numSamples,r=ranges.current.sampleOffset,d=Grid.height,p=[],c=[],u=e.length,h=0;h<u;h++){if(h>=r&&h<r+l){var m=h-r,g=void 0;this.debugOn&&(this.ctx.fillStyle=conf.lightWave),g="quadratic"===conf.distributionLaw?s(d*t(a(m/l,2))):"reverse-quadratic"===conf.distributionLaw?d-s(d*t(a((l-m)/l,2))):s(m/(l/d)),c[g]||(p[g]=0,c[g]=0);var f=Math.min(t(e[h]/256),1);f<conf.absoluteTreshold&&(f=0),p[g]+=f,c[g]+=1}else this.debugOn&&(this.ctx.fillStyle=conf.darkWave);if(this.debugOn){var b=o(100*(e[h]/256));b&&this.ctx.fillRect(h,100-b,1,b)}}for(var y=0;y<d;y++)0<c[y]?p[y]/=c[y]:p[y]=0;for(this.current&&this.history.push(this.current);this.history.length>conf.historySize;)this.history.shift();this.current=p;for(var v=[],J=[],j=0;j<this.history.length;j++)for(var x=0;x<d;x++)v[x]||(v[x]=0),v[x]+=this.history[j][x];for(var w=r,k=0;k<d;k++)0<v[k]?v[k]/=this.history.length:v[k]=0,this.debugOn&&(this.ctx.fillStyle=k%2?"green":"purple",this.ctx.fillRect(w,100,c[k],3),this.ctx.fillRect(w,103,c[k],57*p[k])),this.current[k]>v[k]*ranges.current.treshold?(J[k]=1,this.debugOn&&(this.ctx.fillStyle=k%2?"lime":"magenta",this.ctx.fillRect(w,105+57*p[k]-4,c[k],4))):J[k]=0,this.debugOn&&(w+=c[k]);return J}};VisualizerSample.prototype.draw=function(){this.analyser.smoothingTimeConstant=ranges.current.smoothing,this.analyser.getByteFrequencyData(this.samples),conf.osc&&drawContext.clearRect(0,0,conf.barWidth,conf.barHeight);for(var e=0;e<this.analyser.frequencyBinCount;e++){var t=this.samples[e],a=t/256;if(conf.osc){var o=conf.barHeight*a,s=Math.ceil(conf.barHeight-o);drawContext.fillRect(4*e,s,2,o)}}channel.debugOn&&channel.ctx.clearRect(0,0,conf.fft_size,205);for(var l=channel.tick(this.samples),r=0;r<Grid.height;r++)l[r]&&Grid.flashRow(r);frame(this.draw.bind(this))},VisualizerSample.prototype.getFrequencyValue=function(e){var t=audio.context.sampleRate/2,a=Math.round(e/t*this.freqs.length);return this.freqs[a]};function Rarity(e){this.n=0,this.trim=e,this["do"]=function(e){this.n>=this.trim?(e(),this.n=0):this.n++}}function handleFileDrop(e){handleFile(e,"drop")}function handleFileInput(e){handleFile(e,"input")}var currentCustomTrack={name:null,ftype:null,buffer:null,blob:null};function handleFile(e,t){e.stopPropagation(),e.preventDefault();var a="drop"==t?e.dataTransfer.files:e.target.files,o=a[0];if(o.type.match("image.*")){var s=new FileReader;s.onload=function(){return function(t){var e=t.target.result;toCanvas(e),$("#pattern-share .filename").val(o.name.match(/(.+?)\.([a-z0-9_]+$)/i)[1])}}(o),s.readAsDataURL(o)}else if(o.type.match("audio.*")){var s=new FileReader;s.onload=function(){return function(t){currentCustomTrack.buffer=t.target.result,currentCustomTrack.ftype=o.type,currentCustomTrack.blob=new Blob([currentCustomTrack.buffer],{type:currentCustomTrack.ftype}),currentCustomTrack.name=o.name.match(/(.+?)\.([a-z0-9_]+$)/i)[1],$("#loop-upload .filename").val(currentCustomTrack.name),loopEditor.add(),audio.context.decodeAudioData(currentCustomTrack.buffer,function(e){ranges.sync(),audio.stop(function(){audio.buffer=e,currentLoop.fileName=currentCustomTrack.name,audio.disabled=!1,audio.play()})},function(e){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0434\u0435\u043A\u043E\u0434\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0438 \u0430\u0443\u0434\u0438\u043E",e)})}}(o),s.readAsArrayBuffer(o)}else alert("\u0414\u0440\u043E\u043F\u043D\u0443\u0442\u044B\u0439 \u0444\u0430\u0439\u043B \u043D\u0435 \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F \u043D\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u043E\u0439, \u043D\u0438 \u0430\u0443\u0434\u0438\u043E\u0444\u0430\u0439\u043B\u043E\u043C.");return!1}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function toCanvas(e){var t=new Image;t.onload=function(){bufferCanvas.height=this.height,bufferCanvas.width=this.width,bufferContext.drawImage(this,0,0),Grid.fromCanvas()},t.src=e}function dataURItoBlob(e){var t=e.split(","),a=t[0].match(/:(.*?);/)[1];return new Blob([atob(t[1])],{type:a})}function TrackList(e,t,a,o,s,l,r,n,i){var d=Math.round,p=Math.floor;this.$el=$(t),this.id=a,this.isFlat=!!o,this.playEnabled=n,this.$playEnabler=i,this.$playEnabler.addClass(this.playEnabled?"i-play-enabled":"i-play-disabled"),this.$playEnabler.on("click",function(e){e.stopPropagation(),this.playEnabled=!this.playEnabled,this.$playEnabler.toggleClass("i-play-enabled i-play-disabled"),AllTracks.populate(this.id,this.flatList,this.playEnabled)}.bind(this)),this.build=function(){var e="";this.isFlat?(e+="<div class=\"tracklist-section\" data-flat=\"1\" data-section=\""+this.id+"\" data-id=\""+this.id+"\">",e+=this.buildSection(this.list,this.id),e+="</div>"):_.each(this.list,function(t){e+="<div class=\"tracklist-section\" data-flat=\"0\" data-section=\""+t.sectID+"\" data-id=\""+this.id+"\">",e+="<h3 class=\"tls-title\">"+t.title+"</h3>",e+=this.buildSection(t.contents,t.sectID),e+="</div>"},this),this.$el.html(e),AllTracks.populate(this.id,this.flatList,this.playEnabled)},this.scrollAdded=!1,this.buildSection=function(e,t){r="undefined"==typeof this.sortOrder||("string"==typeof this.sortOrder?"asc"===this.sortOrder:this.sortOrder);var a=_.sortByOrder(e,[this.sortBy,"id"],[r,r]),o="",s="default"===this.id?" foradmin-show":"";return _.each(a,function(e){if(e){var a=!!(e.hasOwnProperty("swf")&&e.swf)&&e.swf.split("/").reverse()[0],l=a?"<a target=\"_blank\" href=\"loops/swf/"+e.swf+"\" download=\""+a+"\" class=\"dlo-dlbutton dlb-swf\" title=\"\u0421\u043A\u0430\u0447\u0430\u0442\u044C \u043E\u0440\u0438\u0433\u0438\u043D\u0430\u043B\u044C\u043D\u044B\u0439 SWF\"><i class=\"i-download-menu\"></i> SWF</a> ":"",r=a?" with-swf":"",n=e.hasOwnProperty("fresh")&&e.fresh?" fresh":"",i=currentLoop.hasOwnProperty("original_hash")&&currentLoop.original_hash===e.original_hash?" playing":"",d=_.escape(e.name);o+="<div class=\"track"+r+i+n+"\" data-name=\""+d.toLowerCase()+"\" data-hash=\""+e.original_hash+"\">\t\t\t\t\t<i class=\"i-play\"></i>\t\t\t\t\t<div class=\"track-name\">"+d+"</div>\t\t\t\t\t<div class=\"download-options\">"+l+"<a target=\"_blank\" href=\"loops/"+t+"/"+e.original_hash+".mp3\" download=\""+d+".mp3\" class=\"dlo-dlbutton dlb-mp3\"><i class=\"i-download-menu\"></i> MP3</a>\t\t\t\t\t\t<a target=\"_blank\" href=\"loops/"+t+"/"+e.original_hash+".ogg\" download=\""+d+".ogg\" class=\"dlo-dlbutton dlb-ogg\"><i class=\"i-download-menu\"></i> OGG</a>\t\t\t\t\t</div>\t\t\t\t\t<div class=\"edit-options\">\t\t\t\t\t\t<a href=\"#\" class=\"dlo-dlbutton dlb-delete\"><i class=\"i-x-small\"></i> \u0423\u0434\u0430\u043B\u0438\u0442\u044C</a>\t\t\t\t\t\t<a href=\"#\" class=\"dlo-dlbutton dlb-edit\"><i class=\"i-edit\"></i> \u041F\u0440\u0430\u0432\u0438\u0442\u044C</a>\t\t\t\t\t</div>\t\t\t\t\t<div class=\"track-duration\">"+e.duration+"</div>\t\t\t\t\t<div class=\"track-options\">\t\t\t\t\t\t<i class=\"i-download-menu\"></i><i class=\"i-burger"+s+"\"></i>\t\t\t\t\t</div>\t\t\t\t</div>"}},this),o},this.add=function(e){e=this.processList([e])[0],e.fresh=!0,this.isFlat?(this.list.push(e),this.flatList=this.list):(_.find(this.list,{sectID:e.section}).contents.push(e),this.flatList=_.flatten(_.pluck(this.list,"contents"))),this.build()},this.edit=function(e){this.del(e.original_hash,e.section_from||e.section,!0),this.add(e)},this.del=function(e,t,a){"undefined"==typeof a&&(a=!1),this.isFlat?_.remove(this.list,{original_hash:e}):_.remove(_.find(this.list,{sectID:t}).contents,{original_hash:e}),_.remove(this.flatList,{original_hash:e}),a||this.build()},this.processList=function(e){return _.each(e,function(e){if(e.hasOwnProperty("date")&&!e.date instanceof Date&&(e.date=new Date(e.date)),e.hasOwnProperty("duration")&&!isNaN(e.duration)){var t=+e.duration,a=p(t/60)+"";1==a.length&&(a="0"+a);var o=d(t%60)+"";1==o.length&&(o="0"+o),e.duration=a+":"+o}["freq","db"].forEach(function(t){e[t]&&"string"==typeof e[t]&&(e[t]=e[t].split("~").map(function(e){return+e}))}),["smoothing","treshold"].forEach(function(t){e[t]&&"string"==typeof e[t]&&(e[t]=+e[t])})})},this.sortOptions=[["date","desc","i-newfirst","\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043D\u043E\u0432\u044B\u0435"],["date","asc","i-oldfirst","\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u0442\u0430\u0440\u044B\u0435"],["name","asc","i-a-z","\u041F\u043E \u0430\u043B\u0444\u0430\u0432\u0438\u0442\u0443"],["name","desc","i-z-a","\u041F\u043E \u0430\u043B\u0444\u0430\u0432\u0438\u0442\u0443"]],this.isFlat?(this.list=this.processList(e),this.flatList=this.list):(this.list=_.map(e,function(e){var t=e;return t.contents=this.processList(e.contents),t},this),this.flatList=_.flatten(_.pluck(this.list,"contents"))),this.sortButton=s,this.sortButton.on("click",function(e){e.stopPropagation(),this.sort()}.bind(this)),this.sortState=_.findIndex(this.sortOptions,{0:l,1:r}),this.sort=function(e,t){var a;"undefined"==typeof e?this.sortState++:("undefined"==typeof t&&(t="asc"),this.sortState=_.findIndex(this.sortOptions,{0:e,1:t})),(0>this.sortState||this.sortState>=this.sortOptions.length)&&(this.sortState=0),a=this.sortOptions[this.sortState],this.sortBy=a[0],this.sortOrder=a[1],this.build(),this.sortButton.removeClass(_.pluck(this.sortOptions,2).join(" ")).addClass(a[2]),this.sortButton.attr("title",a[3])},this.sort(l,r),this.playTrackByHash=function(e,t){"undefined"==typeof t&&(t=!1);var a=_.filter(this.flatList,{original_hash:""+e})[0];a&&(audio.loadLoop(!0,a),$(".track").removeClass("playing"),$(".track[data-hash="+e+"]").addClass("playing"),conf.association&&!t&&(+a.associated_pattern?_.each(patternLibs,function(e){e.applyPatternByID(+a.associated_pattern,!0)}):Grid.revert()))},this.getAllHashes=function(){return{playEnabled:this.playEnabled,tracks:_.pluck(this.flatList,"original_hash")}}}var AllTracks={nameList:[],playList:[],populate:function populate(e,t,a){var o=_.reject(this.playList,{lib:e}),s=_.reject(this.nameList,{lib:e});_.each(t,function(t){s.push({lib:e,hash:t.original_hash,name:t.name}),a&&o.push({lib:e,hash:t.original_hash})}),$("#loop-toassoc option[data-lib="+e+"]").remove(),this.nameList=s,this.playList=o,_.each(s,function(t){$("#loop-toassoc").append("<option data-lib=\""+e+"\" value=\""+t.hash+"\">"+t.name+"</option>")})},random:function random(){var e=Math.floor;if(this.playList.length||this.init(),!!this.playList.length){if(1<this.playList.length)var t=this.playList.filter(function(e){return e.hash!==currentLoop.original_hash});var a=1<this.playList.length?t[e(Math.random()*t.length)]:this.playList[0];loopLibs[a.lib].playTrackByHash(a.hash)}},playTrackByHash:function playTrackByHash(e,t){loopLibs[_.find(this.nameList,{hash:""+e}).lib].playTrackByHash(""+e,t)}};function PatternGallery(e,t,a,o,s,l){var r=Math.ceil,i=Math.floor;this.$el=$(t),this.id=a,this.processList=function(e){return _.each(e,function(e){e.hasOwnProperty("date")&&!e.date instanceof Date&&(e.date=new Date(e.date)),e.height=+e.height,e.width=+e.width,e.id=+e.id})},this.list=this.processList(e),this.patternProbe=function(e,t){var a=e>t?e:t;if(60>a){for(var o=1;60>=a*o;)o++;o--;var s=o*e,l=o*t,d=60-l,p=60-s;return{up:!0,width:s,height:l,margins:[i(d/2),r(p/2),r(d/2),i(p/2)]}}return{up:!1,width:e,height:t}},this.refreshAss=function(){$("#pattern-toassoc option[data-lib="+this.id+"]").remove(),_.each(this.list,function(e){$("#pattern-toassoc").append("<option data-lib=\""+this.id+"\" value=\""+e.id+"\">"+e.name+"</option>")},this)},this.build=function(){var e=!("undefined"!=typeof this.sortOrder)||("string"==typeof this.sortOrder?!("asc"!==this.sortOrder):this.sortOrder),t=_.sortByOrder(this.list,[this.sortBy,"id"],[e,e]),a="<div class=\"gallery-section\" data-section=\""+this.id+"\" data-id=\""+this.id+"\">",o="default"===this.id?" foradmin-show":"";_.each(t,function(e){var t=this.patternProbe(e.width,e.height),o=t.up?" image-crisp":"",s=t.up?" style=\"margin: "+t.margins.map(function(e){return e+"px"}).join(" ")+"; width:"+t.width+"px; height:"+t.height+"px;\"":"",l=Grid.toCanvas(e.string,e.width,e.height),r=e.fresh||!1?" fresh":"",n=_.escape(e.name),i="default"==this.id?" foradmin-show":"";a+="<div class=\"pattern"+r+"\" title=\""+n+"\" data-id=\""+e.id+"\" data-lib=\""+this.id+"\" data-name=\""+n+"\">\t\t\t\t<img src=\""+l+"\" class=\"pattern-pic"+o+"\""+s+" alt=\""+n+"\">\t\t\t\t<div class=\"pattern-name\">"+n+"</div>\t\t\t\t<div class=\"pattern-options\">\t\t\t\t\t<a title=\"\u041F\u0440\u0430\u0432\u0438\u0442\u044C\" href=\"#\" class=\"pattern-menu-item pmi-left"+i+"\"><i class=\"i-edit\"></i></a>\t\t\t\t\t<a title=\"\u0421\u043A\u0430\u0447\u0430\u0442\u044C PNG\" target=\"_blank\" href=\""+l+"\" download=\""+n+".png\" class=\"pattern-menu-item pmi-mid\"><i class=\"i-download-menu\"></i></a>\t\t\t\t\t<a title=\"\u0423\u0434\u0430\u043B\u0438\u0442\u044C\" href=\"#\" class=\"pattern-menu-item pmi-right"+i+"\"><i class=\"i-x-small\"></i></a>\t\t\t\t</div>\t\t\t</div>"},this),a+="</div>",this.$el.html(a),this.refreshAss()},this.add=function(e){e=this.processList([e])[0],e.fresh=!0,this.list.push(e),this.build()},this.edit=function(e){this.del(+e.id,!0),this.add(e)},this.del=function(e,t){"undefined"==typeof t&&(t=!1),_.remove(this.list,{id:e}),t||this.build()},this.sortOptions=[["date","desc","i-newfirst","\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043D\u043E\u0432\u044B\u0435"],["date","asc","i-oldfirst","\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u0442\u0430\u0440\u044B\u0435"],["name","asc","i-a-z","\u041F\u043E \u0430\u043B\u0444\u0430\u0432\u0438\u0442\u0443"],["name","desc","i-z-a","\u041F\u043E \u0430\u043B\u0444\u0430\u0432\u0438\u0442\u0443"]],this.sortButton=o,this.sortButton.on("click",function(e){e.stopPropagation(),this.sort()}.bind(this)),this.sortState=_.findIndex(this.sortOptions,{0:s,1:l}),this.sort=function(e,t){var a;"undefined"==typeof e?this.sortState++:("undefined"==typeof t&&(t="asc"),this.sortState=_.findIndex(this.sortOptions,{0:e,1:t})),(0>this.sortState||this.sortState>=this.sortOptions.length)&&(this.sortState=0),a=this.sortOptions[this.sortState],this.sortBy=a[0],this.sortOrder=a[1],this.build(),this.sortButton.removeClass(_.pluck(this.sortOptions,2).join(" ")).addClass(a[2]),this.sortButton.attr("title",a[3])},this.sort(s,l),this.applyPatternByID=function(e,t){"undefined"==typeof t&&(t=!1);var a=_.find(this.list,{id:+e});a&&(a.osc?Grid.setOsc(a.osc):$("#osc-sel").val("default"),a.style?Grid.changeStyle(a.style,a.string):Grid.changeStyle(defaultStyle,a.string),a.associated_loop&&conf.association&&!t&&AllTracks.playTrackByHash(a.associated_loop,!0))}}var is_admin=!1;cheet("\u2191 \u2191 \u2193 \u2193 \u2190 \u2192 \u2190 \u2192 b a",function(){$("body").toggleClass("is-admin"),is_admin=!!!is_admin,console.log("Congratulations!")}),Math.log2=Math.log2||function(e){return Math.log(e)/Math.LN2};var $stream=null,radioMES=null;function set_stream(e,t){$stream||($("<audio style=\"display:none\" id=\"stream-victim\"></audio>").appendTo("body"),$stream=$("#stream-victim")),$stream.html("<source src=\""+e+"\" type=\""+t+"\" />")}function connectStream(){radioMES=audio.context.createMediaElementSource($("#stream-victim")[0]),radioMES.connect(gainNode)}function toggleAnlzOpts(){$("#nerdmode").slideToggle("fast"),channel.debugOn=!channel.debugOn}
//# sourceMappingURL=loops.js.map